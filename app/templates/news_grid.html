{% extends "base.html" %}

{% block title %}آخرین اخبار - Newsroom{% endblock %}

{% block content %}
<div class="news-layout">
    <aside class="sources-sidebar">
        <div class="sidebar-section">
            <h2>منابع خبری</h2>
            <ul class="sources-list">
                <li>
                    <a href="/ui/news{% if current_category or current_query %}?{% endif %}{% if current_category %}category={{ current_category }}{% endif %}{% if current_category and current_query %}&{% endif %}{% if current_query %}q={{ current_query }}{% endif %}" 
                       class="{% if not current_source or current_source == '' %}active{% endif %}">
                        همه منابع
                    </a>
                </li>
                {% for source_item in sources %}
                <li>
                    <a href="/ui/news?source={{ source_item.key }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_query %}&q={{ current_query }}{% endif %}" 
                       class="{% if current_source and current_source|string == source_item.key|string %}active{% endif %}">
                        {{ source_item.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="sidebar-section">
            <h2>دسته‌بندی‌ها</h2>
            <ul class="sources-list">
                <li>
                    <a href="/ui/news{% if current_source or current_query %}?{% endif %}{% if current_source %}source={{ current_source }}{% endif %}{% if current_source and current_query %}&{% endif %}{% if current_query %}q={{ current_query }}{% endif %}" 
                       class="{% if not current_category %}active{% endif %}">
                        همه دسته‌بندی‌ها
                    </a>
                </li>
                {% for cat_item in categories %}
                <li>
                    <a href="/ui/news?category={{ cat_item.key }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_query %}&q={{ current_query }}{% endif %}" 
                       class="{% if current_category == cat_item.key %}active{% endif %}">
                        {{ cat_item.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </aside>
    
    <div class="news-content-area">
        {% if search_error %}
        <div class="search-error">
            <p>{{ search_error }}</p>
        </div>
        {% endif %}
        
        <!-- View Mode Toggle -->
        <div class="view-mode-toggle">
            <button id="gridViewBtn" class="view-btn active" onclick="switchViewMode('grid')" title="نمایش گرید">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <rect x="12" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <rect x="2" y="12" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <rect x="12" y="12" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                </svg>
            </button>
            <button id="listViewBtn" class="view-btn" onclick="switchViewMode('list')" title="نمایش لیست">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="3" width="16" height="2" rx="1" fill="currentColor"/>
                    <rect x="2" y="9" width="16" height="2" rx="1" fill="currentColor"/>
                    <rect x="2" y="15" width="16" height="2" rx="1" fill="currentColor"/>
                </svg>
            </button>
        </div>
        
        <div class="news-grid" id="newsContainer">
            {% if articles %}
                {% for article in articles %}
        <article class="news-card" data-news-id="{{ article.id }}" onclick="openNewsModal('{{ article.id }}')">
            <a href="javascript:void(0);" class="news-card-link">
                <!-- Grid View Structure -->
                <div class="news-card-grid-view">
                    {% if article.image_url %}
                    <div class="news-image{% if article.is_vertical_image %} news-image-vertical{% endif %}">
                        <img src="{{ article.image_url }}" alt="{{ article.title }}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"{% if article.is_vertical_image %} style="object-fit: contain; background-color: #000; height: auto; max-height: 400px; width: 100%;"{% endif %}>
                        <div class="image-placeholder" style="display: none;">
                            <span>بدون تصویر</span>
                        </div>
                        <span class="source-badge" style="background-color: {{ article.source_color }};">
                            {{ article.source_persian }}
                        </span>
                    </div>
                    {% else %}
                    <div class="news-image">
                        <div class="image-placeholder">
                            <span>بدون تصویر</span>
                        </div>
                        <span class="source-badge" style="background-color: {{ article.source_color }};">
                            {{ article.source_persian }}
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="news-content">
                        <h2 class="news-title" dir="{{ 'rtl' if article.language in ['ar', 'fa'] else 'ltr' }}"{% if article.is_breaking %} style="color: #e74c3c; font-weight: bold;"{% endif %}>{{ article.title }}</h2>
                    </div>
                    
                    <div class="news-footer">
                        <div class="news-footer-left">
                            {% if article.raw_category %}
                            <span class="news-category">{{ article.raw_category }}</span>
                            {% elif article.category_persian %}
                            <span class="news-category">{{ article.category_persian }}</span>
                            {% endif %}
                        </div>
                        {% if article.published_at %}
                        <span class="news-date">{{ article.published_at|persian_date }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- List View Structure -->
                <div class="news-card-grid">
                    <div class="news-source-col">
                        <span class="source-badge" style="background-color: {{ article.source_color }};">
                            {{ article.source_persian }}
                        </span>
                    </div>
                    <div class="news-title-col">
                        <h2 class="news-title" dir="{{ 'rtl' if article.language in ['ar', 'fa'] else 'ltr' }}"{% if article.is_breaking %} style="color: #e74c3c; font-weight: bold;"{% endif %}>{{ article.title }}</h2>
                        {% if article.raw_category or article.category_persian %}
                        <span class="news-category">
                            {% if article.raw_category %}
                                {{ article.raw_category }}
                            {% elif article.category_persian %}
                                {{ article.category_persian }}
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>
                    <div class="news-date-col">
                        {% if article.published_at %}
                        <span class="news-date">{{ article.published_at|persian_date }}</span>
                        {% endif %}
                    </div>
                </div>
            </a>
        </article>
        {% endfor %}
            {% else %}
                <div class="no-news">
                    <p>{% if current_query %}نتیجه‌ای برای "{{ current_query }}" یافت نشد.{% else %}هیچ خبری یافت نشد.{% endif %}</p>
                </div>
            {% endif %}
        </div>
        
        {% if pagination.has_more %}
        <div id="loading-indicator" class="loading-indicator" style="display: none;">
            <div class="loading-spinner"></div>
            <p>در حال بارگذاری اخبار بیشتر...</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Scroll to Top Button -->
<button id="scrollToTopBtn" class="scroll-to-top" onclick="scrollToTop()" title="بازگشت به بالا">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 19V5M12 5L5 12M12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<!-- News Modal -->
<div id="newsModal" class="modal">
    <div class="modal-overlay" onclick="closeNewsModal()"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeNewsModal()">&times;</button>
        <div id="modalBody" class="modal-body">
            <div class="modal-loading">در حال بارگذاری...</div>
        </div>
    </div>
</div>

<script>
async function openNewsModal(newsId) {
    const modal = document.getElementById('newsModal');
    const modalBody = document.getElementById('modalBody');
    
    // Stop any existing videos before opening new modal
    const existingVideos = modal.querySelectorAll('video');
    existingVideos.forEach(video => {
        video.pause();
        video.currentTime = 0;
    });
    
    // Show modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Show loading
    modalBody.innerHTML = '<div class="modal-loading">در حال بارگذاری...</div>';
    
    try {
        // Fetch news details
        const response = await fetch(`/news/${newsId}`);
        if (!response.ok) {
            throw new Error('خطا در دریافت خبر');
        }
        
        const article = await response.json();
        
        // Highlight search words in title and summary
        let highlightedTitle = escapeHtml(article.title);
        let highlightedSummary = article.summary ? escapeHtml(article.summary) : '';
        let highlightedBody = article.body_html || '';
        
        if (searchWords && searchWords.length > 0) {
            highlightedTitle = highlightText(highlightedTitle, searchWords);
            if (highlightedSummary) {
                highlightedSummary = highlightText(highlightedSummary, searchWords);
            }
            if (highlightedBody) {
                highlightedBody = highlightInHTML(highlightedBody, searchWords);
            }
        }
        
        // Render article content
        modalBody.innerHTML = `
            <div class="modal-news-header">
                <h1 id="modalNewsTitle" class="modal-news-title" dir="${article.language == 'ar' || article.language == 'fa' ? 'rtl' : 'ltr'}" style="text-align: ${article.language == 'ar' || article.language == 'fa' ? 'right' : 'left'};${article.is_breaking ? ' color: #e74c3c; font-weight: bold;' : ''}${article.language == 'ar' || article.language == 'fa' ? ' font-family: \'Vazir\', \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; font-weight: 600;' : ''}">${highlightedTitle}</h1>
                <div class="modal-news-meta">
                    <span class="news-source">${escapeHtml(article.source_persian || article.source)}</span>
                    ${article.published_at ? `<span class="news-date">${formatPersianDate(article.published_at)}</span>` : ''}
                    ${article.raw_category ? `<span class="news-category">${escapeHtml(article.raw_category)}</span>` : (article.category ? `<span class="news-category">${escapeHtml(article.category)}</span>` : '')}
                </div>
            </div>
            ${highlightedSummary ? `
                <div id="modalNewsSummary" class="modal-news-summary">
                    <p>${highlightedSummary}</p>
                </div>
            ` : ''}
            ${highlightedBody ? `
                <div class="modal-news-content-controls">
                    <button id="toggleRtlBtn" class="rtl-toggle-btn" onclick="toggleRtlAlignment()" title="تغییر تراز متن">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 3H15M3 9H15M3 15H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>راست‌چین</span>
                    </button>
                </div>
                <div id="modalNewsBody" class="modal-news-body" dir="${article.language == 'ar' || article.language == 'fa' ? 'rtl' : 'ltr'}" style="text-align: ${article.language == 'ar' || article.language == 'fa' ? 'right' : 'left'};${article.language == 'ar' || article.language == 'fa' ? ' font-family: \'Vazir\', \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;' : ''}">
                    ${highlightedBody}
                </div>
            ` : ''}
            <div class="modal-news-footer">
                ${article.url ? `
                <a href="${escapeHtml(article.url)}" target="_blank" rel="noopener noreferrer" class="original-link">
                    مشاهده خبر اصلی →
                </a>
                ` : ''}
            </div>
        `;
    } catch (error) {
        modalBody.innerHTML = `
            <div class="modal-error">
                <p>خطا در بارگذاری خبر: ${escapeHtml(error.message)}</p>
            </div>
        `;
    }
}

// Toggle RTL alignment for modal content
function toggleRtlAlignment() {
    const modalBody = document.getElementById('modalNewsBody');
    const modalTitle = document.getElementById('modalNewsTitle');
    const modalSummary = document.getElementById('modalNewsSummary');
    const toggleBtn = document.getElementById('toggleRtlBtn');
    const btnSpan = toggleBtn ? toggleBtn.querySelector('span') : null;
    
    if (!modalBody && !modalTitle) return;
    
    // Toggle body
    if (modalBody) {
        const currentDir = modalBody.getAttribute('dir') || 'ltr';
        const newDir = currentDir === 'rtl' ? 'ltr' : 'rtl';
        const newAlign = newDir === 'rtl' ? 'right' : 'left';
        
        modalBody.setAttribute('dir', newDir);
        modalBody.style.textAlign = newAlign;
        if (newDir === 'rtl') {
            modalBody.style.fontFamily = "'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        } else {
            modalBody.style.fontFamily = '';
        }
    }
    
    // Toggle title
    if (modalTitle) {
        const currentDir = modalTitle.getAttribute('dir') || 'ltr';
        const newDir = currentDir === 'rtl' ? 'ltr' : 'rtl';
        const newAlign = newDir === 'rtl' ? 'right' : 'left';
        
        modalTitle.setAttribute('dir', newDir);
        modalTitle.style.textAlign = newAlign;
        if (newDir === 'rtl') {
            modalTitle.style.fontFamily = "'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            modalTitle.style.fontWeight = '600';
        } else {
            modalTitle.style.fontFamily = '';
            modalTitle.style.fontWeight = '';
        }
    }
    
    // Toggle summary if exists
    if (modalSummary) {
        const currentDir = modalSummary.getAttribute('dir') || 'ltr';
        const newDir = currentDir === 'rtl' ? 'ltr' : 'rtl';
        const newAlign = newDir === 'rtl' ? 'right' : 'left';
        
        modalSummary.setAttribute('dir', newDir);
        modalSummary.style.textAlign = newAlign;
        if (newDir === 'rtl') {
            modalSummary.style.fontFamily = "'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        } else {
            modalSummary.style.fontFamily = '';
        }
    }
    
    // Update button text
    if (btnSpan) {
        btnSpan.textContent = modalBody && modalBody.getAttribute('dir') === 'rtl' ? 'چپ‌چین' : 'راست‌چین';
    }
}

function closeNewsModal() {
    const modal = document.getElementById('newsModal');
    
    // Stop all videos in the modal before closing
    const videos = modal.querySelectorAll('video');
    videos.forEach(video => {
        video.pause();
        video.currentTime = 0; // Reset to beginning
    });
    
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPersianDate(dateStr) {
    if (!dateStr) return '';
    // Date is already converted to Persian by the server, just return as is
    return String(dateStr);
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeNewsModal();
    }
});

// Stop videos when page visibility changes (tab switch, minimize, etc.)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        const modal = document.getElementById('newsModal');
        if (modal && modal.style.display !== 'none') {
            const videos = modal.querySelectorAll('video');
            videos.forEach(video => {
                video.pause();
                video.currentTime = 0;
            });
        }
    }
});

// Highlight search words utility
const searchWords = {{ search_words|tojson }};

function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function highlightText(text, words) {
    if (!text || !words || words.length === 0) return text;
    
    let highlighted = text;
    words.forEach(word => {
        if (word.length < 2) return;
        const escapedWord = escapeRegex(word);
        const regex = new RegExp(`(${escapedWord})`, 'gi');
        highlighted = highlighted.replace(regex, '<mark class="search-highlight">$1</mark>');
    });
    
    return highlighted;
}

function highlightInHTML(htmlString, words) {
    if (!htmlString || !words || words.length === 0) return htmlString;
    
    // Create a temporary container to parse HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    
    // Function to recursively highlight text nodes
    function highlightNode(node, words) {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            const highlighted = highlightText(text, words);
            if (highlighted !== text) {
                const wrapper = document.createElement('span');
                wrapper.innerHTML = highlighted;
                while (wrapper.firstChild) {
                    node.parentNode.insertBefore(wrapper.firstChild, node);
                }
                node.parentNode.removeChild(node);
            }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            // Skip script and style tags
            if (node.tagName === 'SCRIPT' || node.tagName === 'STYLE') {
                return;
            }
            // Recursively process child nodes
            const children = Array.from(node.childNodes);
            children.forEach(child => highlightNode(child, words));
        }
    }
    
    // Highlight all text nodes
    const allNodes = Array.from(tempDiv.childNodes);
    allNodes.forEach(node => highlightNode(node, words));
    
    return tempDiv.innerHTML;
}

// Highlight in news titles on page load
if (searchWords && searchWords.length > 0) {
    document.querySelectorAll('.news-title').forEach(titleEl => {
        const originalText = titleEl.textContent;
        const highlighted = highlightText(originalText, searchWords);
        if (highlighted !== originalText) {
            titleEl.innerHTML = highlighted;
        }
    });
}

// View Mode Toggle Functionality
function switchViewMode(mode) {
    const container = document.getElementById('newsContainer');
    const gridBtn = document.getElementById('gridViewBtn');
    const listBtn = document.getElementById('listViewBtn');
    
    // Remove all view classes
    container.classList.remove('news-grid', 'news-list');
    
    // Remove active class from buttons
    gridBtn.classList.remove('active');
    listBtn.classList.remove('active');
    
    // Add appropriate class and activate button
    if (mode === 'grid') {
        container.classList.add('news-grid');
        gridBtn.classList.add('active');
        localStorage.setItem('newsViewMode', 'grid');
    } else {
        container.classList.add('news-list');
        listBtn.classList.add('active');
        localStorage.setItem('newsViewMode', 'list');
    }
}

// Load saved view mode preference
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('newsViewMode') || 'grid';
    switchViewMode(savedMode);
});

// Infinite scroll functionality
let isLoading = false;
let hasMore = {{ 'true' if pagination.has_more else 'false' }};
let currentOffset = {{ pagination.offset }};
let currentLimit = {{ pagination.limit }};
// Track loaded article IDs to prevent duplicates
const loadedArticleIds = new Set();
// Initialize with current articles on page
document.querySelectorAll('.news-card[data-news-id]').forEach(card => {
    const newsId = card.getAttribute('data-news-id');
    if (newsId) {
        loadedArticleIds.add(newsId);
    }
});

// Hide loading indicator initially if no more articles
const loadingIndicator = document.getElementById('loading-indicator');
if (loadingIndicator && !hasMore) {
    loadingIndicator.style.display = 'none';
}

// Build query parameters
function buildQueryParams(offset) {
    const params = new URLSearchParams();
    params.set('limit', currentLimit);
    params.set('offset', offset);
    {% if current_source %}
    params.set('source', '{{ current_source }}');
    {% endif %}
    {% if current_category %}
    params.set('category', '{{ current_category }}');
    {% endif %}
    {% if current_query %}
    params.set('q', '{{ current_query }}');
    {% endif %}
    return params.toString();
}

// Load more articles
async function loadMoreArticles() {
    if (isLoading || !hasMore) {
        return;
    }
    
    isLoading = true;
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'block';
    }
    
    try {
        const nextOffset = currentOffset + currentLimit;
        const queryParams = buildQueryParams(nextOffset);
        const response = await fetch(`/news/latest?${queryParams}`);
        
        if (!response.ok) {
            throw new Error('خطا در دریافت اخبار');
        }
        
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
            // Append new articles to container (preserves view mode)
            const newsContainer = document.getElementById('newsContainer');
            const newCards = [];
            let addedCount = 0;
            
            data.items.forEach(article => {
                // Skip if article already loaded (prevent duplicates)
                if (loadedArticleIds.has(article.id)) {
                    return;
                }
                
                const articleCard = createArticleCard(article);
                newCards.push(articleCard);
                newsContainer.appendChild(articleCard);
                loadedArticleIds.add(article.id);
                addedCount++;
            });
            
            // Highlight search words in new articles (after appending to DOM)
            if (searchWords && searchWords.length > 0) {
                newCards.forEach(card => {
                    const titleEl = card.querySelector('.news-title');
                    if (titleEl) {
                        const originalText = titleEl.textContent;
                        const highlighted = highlightText(originalText, searchWords);
                        if (highlighted !== originalText) {
                            titleEl.innerHTML = highlighted;
                        }
                    }
                });
            }
            
            // Update pagination state only if we actually added articles
            if (addedCount > 0) {
                currentOffset = nextOffset;
                hasMore = data.pagination && data.pagination.has_more === true;
            } else {
                // If all articles were duplicates, try next page
                currentOffset = nextOffset;
                // Only set hasMore to false if server says no more
                hasMore = data.pagination && data.pagination.has_more === true;
            }
            
            if (!hasMore && indicator) {
                indicator.style.display = 'none';
            }
        } else {
            hasMore = false;
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error loading more articles:', error);
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
            indicator.innerHTML = '<p style="color: #e74c3c;">خطا در بارگذاری اخبار بیشتر</p>';
        }
    } finally {
        isLoading = false;
    }
}

// Create article card element
function createArticleCard(article) {
    const card = document.createElement('article');
    card.className = 'news-card';
    card.setAttribute('data-news-id', article.id);
    card.onclick = () => openNewsModal(article.id);
    
    const imageUrl = article.image_url || '';
    // Prefer server-provided Persian name/color (from API) if present,
    // otherwise fall back to client-side mappings.
    const sourcePersian = article.source_persian || getSourcePersianName(article.source);
    const sourceColor = article.source_color || getSourceColor(article.source);
    const category = article.raw_category || article.category || '';
    const publishedAt = article.published_at || '';
    const isVertical = Boolean(article.is_vertical_image);
    
    card.innerHTML = `
        <a href="javascript:void(0);" class="news-card-link">
            <!-- Grid View Structure -->
            <div class="news-card-grid-view">
                ${imageUrl ? `
                    <div class="news-image${isVertical ? ' news-image-vertical' : ''}">
                        <img src="${imageUrl.replace(/"/g, '&quot;')}" alt="${escapeHtml(article.title)}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"${isVertical ? ' style="object-fit: contain; background-color: #000; height: auto; max-height: 400px; width: 100%;"' : ''}>
                        <div class="image-placeholder" style="display: none;">
                            <span>بدون تصویر</span>
                        </div>
                        <span class="source-badge" style="background-color: ${sourceColor};">
                            ${escapeHtml(sourcePersian)}
                        </span>
                    </div>
                ` : `
                    <div class="news-image">
                        <div class="image-placeholder">
                            <span>بدون تصویر</span>
                        </div>
                        <span class="source-badge" style="background-color: ${sourceColor};">
                            ${escapeHtml(sourcePersian)}
                        </span>
                    </div>
                `}
                <div class="news-content">
                    <h2 class="news-title" dir="${article.language == 'ar' || article.language == 'fa' ? 'rtl' : 'ltr'}" style="text-align: ${article.language == 'ar' || article.language == 'fa' ? 'right' : 'left'};${article.is_breaking ? ' color: #e74c3c; font-weight: bold;' : ''}">${escapeHtml(article.title)}</h2>
                </div>
                <div class="news-footer">
                    <div class="news-footer-left">
                        ${category ? `<span class="news-category">${escapeHtml(category)}</span>` : ''}
                    </div>
                    ${publishedAt ? `<span class="news-date">${formatPersianDate(publishedAt)}</span>` : ''}
                </div>
            </div>
            
            <!-- List View Structure -->
            <div class="news-card-grid">
                <div class="news-source-col">
                    <span class="source-badge" style="background-color: ${sourceColor};">
                        ${escapeHtml(sourcePersian)}
                    </span>
                </div>
                <div class="news-title-col">
                    <h2 class="news-title" dir="${article.language == 'ar' || article.language == 'fa' ? 'rtl' : 'ltr'}" style="text-align: ${article.language == 'ar' || article.language == 'fa' ? 'right' : 'left'};${article.is_breaking ? ' color: #e74c3c; font-weight: bold;' : ''}">${escapeHtml(article.title)}</h2>
                    ${category ? `<span class="news-category">${escapeHtml(category)}</span>` : ''}
                </div>
                <div class="news-date-col">
                    ${publishedAt ? `<span class="news-date">${formatPersianDate(publishedAt)}</span>` : ''}
                </div>
            </div>
        </a>
    `;
    
    return card;
}

// Source names mapping
const sourceNames = {
    "mizan": "خبرگزاری میزان",
    "mehrnews": "خبرگزاری مهر",
    "isna": "خبرگزاری ایسنا",
    "irna": "خبرگزاری ایرنا",
    "tasnim": "خبرگزاری تسنیم",
    "fars": "خبرگزاری فارس",
    "iribnews": "خبرگزاری صداوسیما",
    "ilna": "ایلنا",
    "kayhan": "کیهان",
    "mizan": "خبرگزاری میزان",
    "varzesh3": "ورزش3",
    "mashreghnews": "مشرق‌نیوز",
    "yjc": "باشگاه خبرنگاران جوان",
    "iqna": "خبرگزاری ایکنا",
    "hamshahri": "همشهری‌آنلاین",
    "donyaeqtesad": "دنیای اقتصاد",
    "snn": "خبرگزاری دانشجو",
    "reuters_photos": "رویترز عکس",
    "reuters_text": "رویترز متن",
    "reuters_video": "رویترز ویدئو",
        "afp_text": "فرانس‌پرس متن",
        "afp_video": "فرانس‌پرس ویدئو",
        "afp_photo": "فرانس‌پرس عکس",
        "aptn_text": "AP متن"
};

// Source colors mapping
const sourceColors = {
    "mehrnews": "#e74c3c",
    "isna": "#3498db",
    "irna": "#2ecc71",
    "tasnim": "#f39c12",
    "fars": "#9b59b6",
    "iribnews": "#16a085",
    "ilna": "#e67e22",
    "kayhan": "#c0392b",
    "mizan": "#8e44ad",
    "varzesh3": "#27ae60",
    "mashreghnews": "#d35400",
    "yjc": "#2980b9",
    "iqna": "#8e44ad",
    "hamshahri": "#e67e22",
    "donyaeqtesad": "#16a085",
    "snn": "#e74c3c",
    "reuters_photos": "#c0392b",
    "reuters_text": "#c0392b",
    "reuters_video": "#c0392b",
    "afp_text": "#1f77b4",
    "afp_video": "#ff7f0e",
    "afp_photo": "#2ca02c"
};

function getSourcePersianName(source) {
    return sourceNames[source] || source;
}

function getSourceColor(source) {
    return sourceColors[source] || "#95a5a6";
}

// Scroll to Top Button
const scrollToTopBtn = document.getElementById('scrollToTopBtn');

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Show/hide scroll to top button based on scroll position
let scrollTimeout;
let lastScrollTime = 0;
const SCROLL_THROTTLE = 300; // Throttle scroll events to every 300ms

window.addEventListener('scroll', () => {
    const now = Date.now();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    // Throttle scroll events
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Show scroll to top button when scrolled down more than 300px
        if (scrollTop > 300) {
            scrollToTopBtn.classList.add('visible');
        } else {
            scrollToTopBtn.classList.remove('visible');
        }
        
        // Check if user scrolled near bottom (within 300px) for infinite scroll
        // Only trigger if:
        // 1. Not currently loading
        // 2. Has more articles
        // 3. Enough time has passed since last check
        const timeDelta = now - lastScrollTime;
        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);
        
        if (distanceFromBottom <= 300 && 
            !isLoading && 
            hasMore && 
            timeDelta > SCROLL_THROTTLE) {
            loadMoreArticles();
            lastScrollTime = now;
        }
    }, 100);
});

// Download HQ video function
window.downloadHqVideo = async function downloadHqVideo(newsId) {
    console.log('downloadHqVideo called with newsId:', newsId);
    
    const btn = document.getElementById(`downloadHqVideoBtn-${newsId}`);
    const progressDiv = document.getElementById(`downloadProgress-${newsId}`);
    const progressBar = document.getElementById(`progressBar-${newsId}`);
    const progressText = document.getElementById(`progressText-${newsId}`);
    const resultDiv = document.getElementById(`downloadResult-${newsId}`);
    
    if (!btn || !progressDiv || !progressBar || !progressText || !resultDiv) {
        console.error('Download elements not found:', {
            btn: !!btn,
            progressDiv: !!progressDiv,
            progressBar: !!progressBar,
            progressText: !!progressText,
            resultDiv: !!resultDiv,
            newsId: newsId
        });
        alert('خطا: عناصر دانلود یافت نشد');
        return;
    }
    
    console.log('Starting download...');
    
    // Disable button
    btn.disabled = true;
    btn.textContent = 'در حال دانلود...';
    
    // Show progress
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'شروع دانلود...';
    resultDiv.style.display = 'none';
    
    try {
        // Start download task
        console.log('Starting download task...');
        const startResponse = await fetch(`/news/${newsId}/download-hq-video/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!startResponse.ok) {
            throw new Error('Failed to start download');
        }
        
        const startData = await startResponse.json();
        const taskId = startData.task_id;
        console.log('Download task started, task_id:', taskId);
        
        // Connect to status stream
        const url = `/news/${newsId}/download-hq-video?task_id=${taskId}`;
        console.log('Connecting to:', url);
        
        const eventSource = new EventSource(url);
        
        eventSource.onopen = function() {
            console.log('EventSource connection opened');
        };
        
        eventSource.onmessage = function(event) {
            console.log('Received message:', event.data);
            try {
                const data = JSON.parse(event.data);
                console.log('Parsed data:', data);
                
                if (data.status === 'error') {
                    progressText.textContent = 'خطا: ' + (data.message || 'خطای ناشناخته');
                    progressBar.style.backgroundColor = '#e74c3c';
                    btn.disabled = false;
                    btn.textContent = 'دانلود ویدیوی اصلی';
                    eventSource.close();
                    return;
                }
                
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                }
                
                if (data.message) {
                    progressText.textContent = data.message;
                }
                
                if (data.status === 'completed' || data.status === 'success') {
                    progressBar.style.width = '100%';
                    progressText.textContent = 'دانلود با موفقیت انجام شد!';
                    
                    if (data.presigned_url) {
                        resultDiv.innerHTML = `
                            <a href="${data.presigned_url}" download style="display: inline-block; padding: 10px 20px; background-color: #27ae60; color: white; text-decoration: none; border-radius: 5px; font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                دانلود فایل
                            </a>
                        `;
                        resultDiv.style.display = 'block';
                    }
                    
                    btn.disabled = false;
                    btn.textContent = 'دانلود ویدیوی اصلی';
                    eventSource.close();
                }
            } catch (parseError) {
                console.error('Error parsing JSON:', parseError, 'Raw data:', event.data);
                progressText.textContent = 'خطا در پردازش پاسخ سرور';
                progressBar.style.backgroundColor = '#e74c3c';
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            progressText.textContent = 'خطا در اتصال به سرور';
            progressBar.style.backgroundColor = '#e74c3c';
            btn.disabled = false;
            btn.textContent = 'دانلود ویدیوی اصلی';
            eventSource.close();
        };
        
    } catch (error) {
        console.error('Error in downloadHqVideo:', error);
        progressText.textContent = 'خطا: ' + error.message;
        progressBar.style.backgroundColor = '#e74c3c';
        btn.disabled = false;
        btn.textContent = 'دانلود ویدیوی اصلی';
    }
}
</script>
{% endblock %}

