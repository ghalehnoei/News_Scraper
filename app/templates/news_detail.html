{% extends "base.html" %}

{% block title %}{{ article.title }} - Newsroom{% endblock %}

{% block content %}
<div class="news-detail">
    <div class="news-header">
        <a href="/ui/news" class="back-link">← بازگشت به لیست اخبار</a>
        <h1 id="newsTitle" class="news-title" dir="{{ 'rtl' if article.language in ['ar', 'fa'] else 'ltr' }}" style="text-align: {{ 'right' if article.language in ['ar', 'fa'] else 'left' }};{% if article.is_breaking %} color: #e74c3c; font-weight: bold;{% endif %}{% if article.language in ['ar', 'fa'] %} font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 600;{% endif %}">{{ article.title }}</h1>
        <div class="news-meta">
            <span class="news-source">{{ article.source }}</span>
            {% if article.published_at %}
            <span class="news-date">{{ article.published_at|persian_date }}</span>
            {% endif %}
            {% if article.category %}
            <span class="news-category">{{ article.category }}</span>
            {% endif %}
        </div>
    </div>
    
    {% if article.source == 'afp_video' %}
        {% if article.body_html %}
        <div class="news-content-controls">
            <button id="toggleRtlBtn" class="rtl-toggle-btn" onclick="toggleRtlAlignment()" title="تغییر تراز متن">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 3H15M3 9H15M3 15H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>راست‌چین</span>
            </button>
        </div>
        <div id="newsBody" class="news-body" dir="{{ 'rtl' if article.language in ['ar', 'fa'] else 'ltr' }}"{% if article.language in ['ar', 'fa'] %} style="font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"{% endif %}>
            {{ article.body_html|safe }}
        </div>
        {% endif %}
    {% else %}
        {% if article.image_url %}
        <div class="news-image-large">
            <img src="{{ article.image_url }}" alt="{{ article.title }}"
                 onerror="this.style.display='none';">
        </div>
        {% endif %}
    {% endif %}

    {% if article.summary %}
    <div id="newsSummary" class="news-summary"{% if article.language in ['ar', 'fa'] %} style="font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"{% endif %}>
        <p>{{ article.summary }}</p>
    </div>
    {% endif %}
    
    {% if article.body_html and article.source != 'afp_video' %}
    <div class="news-content-controls">
        <button id="toggleRtlBtn" class="rtl-toggle-btn" onclick="toggleRtlAlignment()" title="تغییر تراز متن">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3H15M3 9H15M3 15H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>راست‌چین</span>
        </button>
    </div>
    <div id="newsBody" class="news-body" dir="{{ 'rtl' if article.language in ['ar', 'fa'] else 'ltr' }}"{% if article.language in ['ar', 'fa'] %} style="font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"{% endif %}>
        {{ article.body_html|safe }}
    </div>
    {% endif %}
    
    {% if article.url %}
    <div class="news-footer-detail">
        <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" class="original-link">
            مشاهده خبر اصلی →
        </a>
    </div>
    {% endif %}
</div>

<script>
// Toggle RTL alignment for news content
function toggleRtlAlignment() {
    const newsBody = document.getElementById('newsBody');
    const newsTitle = document.getElementById('newsTitle');
    const newsSummary = document.getElementById('newsSummary');
    const toggleBtn = document.getElementById('toggleRtlBtn');
    const btnSpan = toggleBtn ? toggleBtn.querySelector('span') : null;
    
    if (!newsBody && !newsTitle) return;
    
    // Toggle body
    if (newsBody) {
        const currentDir = newsBody.getAttribute('dir') || 'ltr';
        const newDir = currentDir === 'rtl' ? 'ltr' : 'rtl';
        const newAlign = newDir === 'rtl' ? 'right' : 'left';
        
        newsBody.setAttribute('dir', newDir);
        newsBody.style.textAlign = newAlign;
        if (newDir === 'rtl') {
            newsBody.style.fontFamily = "'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        } else {
            newsBody.style.fontFamily = '';
        }
    }
    
    // Toggle title
    if (newsTitle) {
        const currentDir = newsTitle.getAttribute('dir') || 'ltr';
        const newDir = currentDir === 'rtl' ? 'ltr' : 'rtl';
        const newAlign = newDir === 'rtl' ? 'right' : 'left';
        
        newsTitle.setAttribute('dir', newDir);
        newsTitle.style.textAlign = newAlign;
        if (newDir === 'rtl') {
            newsTitle.style.fontFamily = "'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            newsTitle.style.fontWeight = '600';
        } else {
            newsTitle.style.fontFamily = '';
            newsTitle.style.fontWeight = '';
        }
    }
    
    // Toggle summary if exists
    if (newsSummary) {
        const currentDir = newsSummary.getAttribute('dir') || 'ltr';
        const newDir = currentDir === 'rtl' ? 'ltr' : 'rtl';
        const newAlign = newDir === 'rtl' ? 'right' : 'left';
        
        newsSummary.setAttribute('dir', newDir);
        newsSummary.style.textAlign = newAlign;
        if (newDir === 'rtl') {
            newsSummary.style.fontFamily = "'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        } else {
            newsSummary.style.fontFamily = '';
        }
    }
    
    // Update button text
    if (btnSpan) {
        btnSpan.textContent = newsBody && newsBody.getAttribute('dir') === 'rtl' ? 'چپ‌چین' : 'راست‌چین';
    }
}


// Stop all videos when page is unloaded or navigated away
function stopAllVideos() {
    const videos = document.querySelectorAll('video');
    videos.forEach(video => {
        video.pause();
        video.currentTime = 0;
    });
}

// Stop videos when page is about to unload
window.addEventListener('beforeunload', stopAllVideos);

// Stop videos when page visibility changes (tab switch, minimize, etc.)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAllVideos();
    }
});

// Stop videos when navigating back (using popstate)
window.addEventListener('popstate', stopAllVideos);

// Stop videos when clicking on back link
document.addEventListener('DOMContentLoaded', function() {
    const backLink = document.querySelector('.back-link');
    if (backLink) {
        backLink.addEventListener('click', function(e) {
            stopAllVideos();
            // Allow navigation to proceed
        });
    }
});

// Download HQ video function
window.downloadHqVideo = async function downloadHqVideo(newsId) {
    console.log('downloadHqVideo called with newsId:', newsId);
    
    const btn = document.getElementById('downloadHqVideoBtn');
    const progressDiv = document.getElementById('downloadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultDiv = document.getElementById('downloadResult');
    
    if (!btn || !progressDiv || !progressBar || !progressText || !resultDiv) {
        console.error('Download elements not found:', {
            btn: !!btn,
            progressDiv: !!progressDiv,
            progressBar: !!progressBar,
            progressText: !!progressText,
            resultDiv: !!resultDiv
        });
        alert('خطا: عناصر دانلود یافت نشد');
        return;
    }
    
    console.log('Starting download...');
    
    // Disable button
    btn.disabled = true;
    btn.textContent = 'در حال دانلود...';
    
    // Show progress
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'شروع دانلود...';
    resultDiv.style.display = 'none';
    
    try {
        // Start download task
        console.log('Starting download task...');
        const startResponse = await fetch(`/news/${newsId}/download-hq-video/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!startResponse.ok) {
            throw new Error('Failed to start download');
        }
        
        const startData = await startResponse.json();
        const taskId = startData.task_id;
        console.log('Download task started, task_id:', taskId);
        
        // Connect to status stream
        const url = `/news/${newsId}/download-hq-video?task_id=${taskId}`;
        console.log('Connecting to:', url);
        
        const eventSource = new EventSource(url);
        
        eventSource.onopen = function() {
            console.log('EventSource connection opened');
        };
        
        eventSource.onmessage = function(event) {
            console.log('Received message:', event.data);
            try {
                const data = JSON.parse(event.data);
                console.log('Parsed data:', data);
                
                if (data.status === 'error') {
                    progressText.textContent = 'خطا: ' + (data.message || 'خطای ناشناخته');
                    progressBar.style.backgroundColor = '#e74c3c';
                    btn.disabled = false;
                    btn.textContent = 'دانلود ویدیوی اصلی';
                    eventSource.close();
                    return;
                }
                
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                }
                
                if (data.message) {
                    progressText.textContent = data.message;
                }
                
                if (data.status === 'completed' || data.status === 'success') {
                    progressBar.style.width = '100%';
                    progressText.textContent = 'دانلود با موفقیت انجام شد!';
                    
                    if (data.presigned_url) {
                        resultDiv.innerHTML = `
                            <a href="${data.presigned_url}" download style="display: inline-block; padding: 10px 20px; background-color: #27ae60; color: white; text-decoration: none; border-radius: 5px; font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                دانلود فایل
                            </a>
                        `;
                        resultDiv.style.display = 'block';
                    }
                    
                    btn.disabled = false;
                    btn.textContent = 'دانلود ویدیوی اصلی';
                    eventSource.close();
                }
            } catch (parseError) {
                console.error('Error parsing JSON:', parseError, 'Raw data:', event.data);
                progressText.textContent = 'خطا در پردازش پاسخ سرور';
                progressBar.style.backgroundColor = '#e74c3c';
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            progressText.textContent = 'خطا در اتصال به سرور';
            progressBar.style.backgroundColor = '#e74c3c';
            btn.disabled = false;
            btn.textContent = 'دانلود ویدیوی اصلی';
            eventSource.close();
        };
        
    } catch (error) {
        console.error('Error in downloadHqVideo:', error);
        progressText.textContent = 'خطا: ' + error.message;
        progressBar.style.backgroundColor = '#e74c3c';
        btn.disabled = false;
        btn.textContent = 'دانلود ویدیوی اصلی';
    }
}
</script>
{% endblock %}

